const GoogleAssistant=require("@bugsounet/google-assistant"),B2M=require("@bugsounet/node-buffertomp3"),Record=require("@bugsounet/node-lpcm16"),path=require("path"),fs=require("fs");var _log=Function.prototype.bind.call(console.log,console,"[GA:AS]"),log=function(){};class ASSISTANT{constructor(e,t=(()=>{})){var s=!!e.debug&&e.debug;if(1==s&&(log=_log),this.modulePath=e.modulePath,this.micConfig=e.micConfig,this.assistantConfig={auth:{keyFilePath:path.resolve(e.modulePath,"credentials.json"),savedTokensPath:path.resolve(e.modulePath,"tokenGA.json")},conversationConfig:{audio:{encodingIn:"LINEAR16",sampleRateIn:16e3,encodingOut:"MP3",sampleRateOut:24e3},deviceLocation:{coordinates:{latitude:e.latitude,longitude:e.longitude}},screen:{isOn:!0},lang:e.lang,isNew:!0}},e.deviceRegistred){try{this.projectId=require("../credentials.json").installed.project_id}catch(e){console.error("[GA:AS] project_id not found on credentials.json")}this.projectId&&(this.assistantConfig.conversationConfig.deviceModelId=this.projectId+"-bugsounet_GA",this.assistantConfig.conversationConfig.deviceId="MMM-GoogleAssistant",log("Used project_id:",this.projectId),log("deviceModelId is:",this.assistantConfig.conversationConfig.deviceModelId),log("deviceId is",this.assistantConfig.conversationConfig.deviceId))}this.debug=s,this.micMode=!1,this.tunnel=t,this.mic=null}activate(e,t=(()=>{})){var s,o=e.type;"TEXT"==o&&(this.assistantConfig.conversationConfig.textQuery=e.key),"MIC"==o&&(this.micMode=!0),0==e.isNew&&(this.assistantConfig.conversationConfig.isNew=!1),s=s=>{this.initConversation(e,s,t)},this.start(s)}start(e){this.assistant=new GoogleAssistant(this.assistantConfig.auth),this.assistant.on("ready",(()=>{this.assistant.start(this.assistantConfig.conversationConfig)})).on("started",e).on("error",(t=>{e.end()}))}initConversation(e,t,s=(e=>{})){this.response={error:{error:null,message:null,audio:!1},action:null,text:null,screen:null,audio:null,transcription:null,continue:!1,volume:null};var o="tmp/lastResponse.mp3",i=path.resolve(this.modulePath,o),n=new B2M({debug:this.debug,file:i});if(this.mic=null,this.micMode){var r={device:null,recorder:"sox",threshold:0,sampleRate:16e3,verbose:!1,debug:this.debug};this.mic=new Record(Object.assign({},r,this.micConfig),t,(e=>{this.afterListening(e)})),log("MIC:RECORDING START."),this.mic.start()}if(t.on("volume-percent",(e=>{log("CONVERSATION:VOLUME",e),this.response.volume=e})).on("end-of-utterance",(()=>{log("CONVERSATION:END_OF_UTTERANCE"),this.micMode&&this.mic&&this.stopListening()})).on("transcription",(e=>{log("CONVERSATION:TRANSCRIPTION",e),this.tunnel({type:"TRANSCRIPTION",payload:e}),this.response.transcription=e})).on("device-action",(e=>{log("CONVERSATION:ACTION",e),this.response.action=Object.assign({},this.response.action,e)})).on("response",(e=>{log("CONVERSATION:RESPONSE",e),e&&(this.response.text=e)})).on("screen-data",(e=>{log("CONVERSATION:SCREEN",typeof e),this.response.screen={originalContent:e.data.toString("utf8")}})).on("audio-data",(e=>{log("CONVERSATION:AUDIO",e.length),e.length&&n.add(e)})).on("ended",((t,r)=>{log("CONVERSATION_ALL_RESPONSES_RECEIVED"),t?(log("CONVERSATION_END:ERROR",t),this.response.error.error=t):r?(log("CONVERSATION_END:CONTINUED"),this.response.continue=!0):(log("CONVERSATION_END:COMPLETED"),this.response.continue=!1),"TEXT"!=e.type||this.response.transcription||(this.response.transcription={transcription:e.key,done:!0}),n.getAudioLength()>50?(log("CONVERSATION_PP:RESPONSE_AUDIO_PROCESSED"),this.response.audio={path:i,uri:o}):(log("CONVERSATION_PP:RESPONSE_AUDIO_TOO_SHORT_OR_EMPTY - ",n.getAudioLength()),this.response.error.audio=!0),n.close(),s(this.response)})).on("error",(e=>{n.close(),console.log("[GA:AS] CONVERSATION_ERROR: "+e),this.response.error.error="CONVERSATION_ERROR",this.response.error.message=e.toString(),"14"==e.code&&console.log("[GA:AS] >> This error might happen when improper configuration or invalid Mic setup."),this.stopListening(),t.end()})),e.key&&"WAVEFILE"==e.type)fs.createReadStream(e.key,{highWaterMark:4096}).pipe(t);"TEXT"==e.type&&this.tunnel({type:"TRANSCRIPTION",payload:{transcription:e.key,done:!0}})}stopListening(){this.mic&&(log("MIC:RECORDING_END"),this.mic.stop(),this.mic=null)}afterListening(e){if(e)return console.log("[GA:AS][ERROR] "+e),void this.stopListening();this.stopListening()}}module.exports=ASSISTANT;